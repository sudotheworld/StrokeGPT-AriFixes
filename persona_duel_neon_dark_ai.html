<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Persona Duel — Neon Pink & Black</title>
<style>
  :root{
    /*--[ NEON/BLACK THEME ]--*/
    --bg: radial-gradient(circle at 10% 20%, rgba(255, 0, 150, 0.15), transparent 40%),
          radial-gradient(circle at 90% 80%, rgba(0, 255, 255, 0.1), transparent 40%),
          #0d0d0f;
    --glass: rgba(20, 20, 25, 0.5);
    --glass-strong: rgba(30, 30, 35, 0.75);
    --text: #e8e8e8;
    --muted: #888;
    --edge: rgba(255, 0, 150, 0.3);
    --brand1: #ff00a0; /* Neon Pink */
    --brand2: #00ffff; /* Neon Cyan */
    --brand3: #00ff00; /* Neon Green */
    --brand4: #ffff00; /* Neon Yellow */
    --brand5: #c400ff; /* Neon Purple */
    --ok: #20bf55;
    --warn: #ff8c42;
    --bad: #ff4d7e;
    --shadow: 0 0 15px rgba(255, 0, 150, 0.2), 0 0 25px rgba(0, 255, 255, 0.1); /* Neon Glow */
    --ring: 0 0 0 3px rgba(255, 0, 150, 0.4);
    --radius-lg: 20px;
    --radius-md: 14px;
    --radius-sm: 10px;
    --chip: 999px;
  }

  /* Rainbow iridescent helpers */
  .rainbow{
    background: conic-gradient(from 180deg, var(--brand1), var(--brand2), var(--brand3), var(--brand4), var(--brand5), var(--brand1));
  }
  .text-rainbow{
    background: linear-gradient(90deg,var(--brand1),var(--brand2),var(--brand3),var(--brand4),var(--brand5));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 0 8px rgba(255, 0, 150, 0.5);
  }

  html, body { height: 100%; }
  body{
    margin:0;
    font-family: ui-rounded, "SF Pro Rounded", "Nunito", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color: var(--text);
    background: var(--bg);
    background-attachment: fixed;
  }
  
  ::placeholder{ color: #555; }

  /* Layout */
  .app{
    display: grid;
    grid-template-columns: 320px 1fr 360px;
    grid-template-rows: auto 1fr auto;
    grid-template-areas:
      "left header right"
      "left main   right"
      "left footer right";
    gap: 16px;
    padding: 16px;
    min-height: 100vh;
    box-sizing: border-box;
  }

  .panel{
    background: var(--glass);
    backdrop-filter: blur(12px) saturate(1.2);
    border: 1px solid var(--edge);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    position: relative;
    transition: background .5s;
  }

  .header{
    grid-area: header;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    font-weight: 800;
    letter-spacing:.2px;
    font-size: 18px;
  }
  .logo{
    width:38px;height:38px;border-radius: 11px; position:relative; overflow:hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12), inset 0 0 0 1px var(--edge);
  }
  .logo:before{ content:""; position:absolute; inset:0; background: conic-gradient(from 200deg, var(--brand1), var(--brand2), var(--brand3), var(--brand4), var(--brand5), var(--brand1)); animation: spin 6s linear infinite; }
  .logo:after{ content:""; position:absolute; inset:3px; border-radius:9px; background: rgba(15,15,20,.9); }
  @keyframes spin { to { transform: rotate(360deg);} }

  .header-actions{
    display:flex; gap:10px; align-items:center;
  }
  .pill{
    border: 1px solid var(--edge); padding:10px 14px; border-radius: var(--chip);
    background: rgba(10,10,10,.5);
    color: var(--text);
    display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:700;
  }
  .pill:hover { filter: brightness(1.2); }
  .pill .dot{ width:8px; height:8px; border-radius:50%; background: var(--brand2); box-shadow: 0 0 6px var(--brand2); }

  /* Sidebars */
  .left{ grid-area: left; display:flex; flex-direction:column; gap:16px; }
  .right{ grid-area: right; display:flex; flex-direction:column; gap:16px; }

  .section{ padding: 14px 16px; }
  .section h3{ margin: 10px 0; font-size: 14px; letter-spacing:.3px; text-transform: uppercase; color: #f0c0e0; text-shadow: 0 0 5px var(--brand1); }
  .field{ display:flex; flex-direction:column; gap:6px; margin-bottom: 10px; }
  label{ font-size:12px; color:#ccc; font-weight: 700; letter-spacing:.2px; }
  input[type="text"], input[type="password"], textarea, select{
    border-radius: 12px; border: 1px solid rgba(255,255,255,.1);
    padding: 10px 12px;
    background: rgba(0,0,0,.3);
    outline: none;
    color: var(--text);
  }
  input:focus, textarea:focus, select:focus{ box-shadow: var(--ring); border-color: var(--brand1); }

  .row{ display:flex; gap:10px; }
  .row > *{ flex:1; }

  .toggle{
    display:flex; align-items:center; gap:10px;
    justify-content: space-between;
    background: rgba(0,0,0,.3);
    border:1px solid rgba(255,255,255,.1);
    padding:10px 12px;border-radius: 12px;
  }
  .switch{ position:relative; width:48px; height:28px; background:#333; border-radius: 999px; transition:.25s; cursor: pointer; }
  .switch:before{
    content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:#111;
    box-shadow: 0 2px 6px rgba(0,0,0,.5); transition:.25s;
  }
  .switch[data-on="true"]{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); box-shadow: 0 0 8px var(--brand1); }
  .switch[data-on="true"]::before{ left:23px; background: white; }

  /* Main center */
  .main{ grid-area: main; display:grid; grid-template-rows: 1fr auto auto; gap:12px; }
  .chat{
    padding:16px;
    display:flex; flex-direction:column; gap:12px; overflow-y: auto;
  }
  .msg{
    max-width: 70%;
    padding:12px 14px; border-radius: 16px; background: rgba(20, 25, 30, 0.7); border:1px solid rgba(255, 0, 150, 0.2);
    box-shadow: 0 4px 10px rgba(0,0,0,.2);
  }
  .msg.you{ margin-left:auto; background: linear-gradient(135deg, rgba(255, 0, 150, 0.2), rgba(255, 0, 150, 0.1)); }
  .msg .tiny{ font-size:11px; color: var(--muted); margin-top:6px; }

  .composer{ display:flex; gap:10px; padding: 10px 12px; align-items:center; }
  .composer input[type="text"]{
    flex:1; padding:12px 14px; border-radius: 999px; border:1px solid rgba(255,255,255,.1); background: rgba(0,0,0,.3);
  }
  .iconbtn{
    border:1px solid var(--edge); background: rgba(10,10,10,.5); border-radius: 999px; width:44px; height:44px; display:grid; place-items:center; cursor:pointer;
  }
  .iconbtn svg path, .iconbtn svg rect { stroke: #bbb; }
  .iconbtn:hover { filter: brightness(1.2); }
  .send{ padding: 12px 18px; border:none; border-radius: 999px; background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:white; font-weight:800; letter-spacing:.3px; box-shadow: 0 2px 8px rgba(0,0,0,.4); cursor:pointer; transition: .2s; }
  .send:hover{ filter: brightness(1.2); box-shadow: 0 0 10px var(--brand1); }

  .rating{
    display:flex; flex-wrap: wrap; gap:8px; padding: 0 14px 12px 14px; align-items:center;
  }
  .rating .label{ font-size:12px; font-weight:800; letter-spacing:.3px; color:#ccc; margin-right:8px; }
  .star{
    --accent: #00ffff;
    position: relative;
    display:inline-grid; place-items:center;
    width:36px; height:36px; border-radius: 10px;
    background: rgba(10,10,10,.5);
    border: 1px solid var(--edge);
    cursor:pointer;
    font-weight: 900;
    font-size: 12px;
    color:var(--text);
  }
  .star[data-sign="neg"]{ --accent: #ff00a0; }
  .star.active{
    outline: 3px solid rgba(0,0,0,0);
    box-shadow: 0 0 12px color-mix(in oklab, var(--accent) 80%, transparent), 0 0 0 3px color-mix(in oklab, var(--accent) 50%, transparent);
  }
  .star .num{ position:relative; z-index:1; }

  .dropzone{
    margin: 8px 14px 16px 14px;
    border: 2px dashed rgba(255, 0, 150, 0.5);
    border-radius: var(--radius-md);
    padding: 16px;
    background: rgba(0,0,0,0.2);
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    transition: border-color .3s ease;
  }
  .dropzone[data-loading="true"]{ border-color: var(--brand2); }
  .dropzone .hint{ color: var(--muted); font-size: 12px; }
  .dropzone .chipbtn{
    border: 1px solid var(--edge); border-radius: var(--chip);
    background: rgba(10,10,10,.5); color: var(--text);
    padding:10px 14px; cursor:pointer; font-weight:800;
  }
  .dropzone .chipbtn:hover { filter: brightness(1.2); }
  .dropzone .statusline{ flex:1 1 100%; font-size:12px; color:var(--muted); margin-top:6px; }

  .funscripts-panel h3{ margin-top:0; }
  .funscripts-header{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
  .funscripts-header .small{ flex:1; }
  .funscripts-list{ display:flex; flex-direction:column; gap:12px; margin-top:8px; }
  .funscript-item{
    border:1px solid rgba(255,255,255,.12);
    border-radius: var(--radius-md);
    padding:12px;
    background: rgba(10,10,15,.55);
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .funscript-item[data-status="processing"],
  .funscript-item[data-status="queued"],
  .funscript-item[data-status="uploading"]{ border-color: rgba(0,255,255,.35); }
  .funscript-item[data-status="error"]{ border-color: var(--bad); }
  .funscript-meta{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
  .funscript-meta h4{ margin:0; font-size:14px; }
  .funscript-status{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius: var(--chip);
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.4px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
  }
  .funscript-status.ready{ border-color: rgba(0,255,128,.4); color:#9ef7c9; }
  .funscript-status.processing, .funscript-status.queued, .funscript-status.uploading{ border-color: rgba(0,255,255,.4); color:#aef7ff; }
  .funscript-status.error{ border-color: rgba(255,77,126,.5); color:#ff9ab7; }
  .funscript-details{ font-size:12px; color: var(--muted); }
  .funscript-tags{ display:flex; flex-wrap:wrap; gap:6px; }
  .tagchip{
    border:1px solid rgba(255,255,255,.15);
    border-radius: var(--chip);
    background: rgba(20,20,25,.6);
    color: var(--text);
    padding:4px 10px;
    font-size:11px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .tagchip:hover{ filter:brightness(1.2); }
  .tagchip[data-action="remove-tag"]{ background: rgba(255,0,160,.1); border-color: rgba(255,0,160,.35); }
  .funscript-actions{ display:flex; flex-wrap:wrap; gap:8px; }
  .chipbtn.favorite-btn.active{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:#fff; border-color: rgba(255,255,255,.4); }
  .funscript-actions .chipbtn:disabled{ opacity:0.6; cursor:not-allowed; }
  .error-text{ color: var(--bad); font-size:12px; }
  .muted{ color: var(--muted); }

  /* PiP Browser (draggable + resizable) */
  .pip{
    position: fixed;
    right: 30px; bottom: 30px;
    width: 380px; height: 240px; z-index: 5;
    background: rgba(15,15,20,.95);
    border: 1px solid var(--edge);
    border-radius: 16px;
    box-shadow: 0 15px 40px rgba(0,0,0,.5), 0 0 15px var(--brand1);
    overflow:hidden;
    display:none;
  }
  .pip.visible{ display:block; }
  .pip .bar{
    height: 40px; display:flex; align-items:center; justify-content:space-between; padding: 0 12px;
    background: linear-gradient(90deg, rgba(20,20,25,.9), rgba(20,20,25,.75));
    cursor: move;
  }
  .pip .bar .title{ font-weight:800; letter-spacing:.3px; }
  .pip iframe{
    border:0; width:100%; height: calc(100% - 40px);
    background: #111;
  }
  .pip .resize{
    position:absolute; width:16px; height:16px; right:8px; bottom:8px; cursor: nwse-resize;
    background: conic-gradient(from 45deg, #666 0 25%, transparent 0 50%, #666 0 75%, transparent 0 100%);
    opacity:.8;
  }

  /* Persona Creator */
  .persona-card{ display:flex; flex-direction:column; gap:10px; }
  .small{ font-size:12px; color: var(--muted); }

  .divider{ height: 1px; background: linear-gradient(90deg, transparent, var(--edge), transparent); margin: 10px 0; }

  .agents{
    display:flex; flex-direction:column; gap:10px;
  }
  .agent{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px; border-radius:12px; background: rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.08);
  }
  .collapser{ cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 12px; border-radius: 12px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); }
  .collapser .arrow{ transition:.25s; }
  .collapser[data-open="true"] .arrow{ transform: rotate(180deg); }
  .collapser svg path { stroke: #bbb; }
  .collapsible{ display:none; }
  .collapsible[data-open="true"]{ display:block; }

  .action{ border:none; padding:10px 12px; border-radius: 12px; font-weight: 800; letter-spacing:.2px; cursor:pointer; box-shadow: 0 2px 8px rgba(0,0,0,.4); transition: .2s; }
  .action:hover{ filter: brightness(1.2); }
  .primary{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:white; }
  .primary:hover{ box-shadow: 0 0 10px var(--brand1); }
  .ghost{ background: transparent; border: 1px solid var(--brand1); color: var(--brand1); }
  .ghost:hover{ background: var(--brand1); color: white; box-shadow: 0 0 10px var(--brand1); }

  /* Footer */
  .footer{ grid-area: footer; display:flex; align-items:center; justify-content: space-between; padding: 12px 16px; }
  .footer .status{ font-size:12px; color: var(--muted); }
  .eq{
    height:12px; width: 170px; border-radius:999px; background: rgba(0,0,0,.3); border:1px solid var(--edge);
    position:relative; overflow:hidden;
  }
  .eq:before{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, var(--brand1), var(--brand2), var(--brand3), var(--brand4), var(--brand5));
    animation: slide 4s linear infinite; width: 200%;
  }
  @keyframes slide {
    0% { transform: translateX(-50%); }
    100% { transform: translateX(0%); }
  }

  /* --- NEW --- AI Theme Style */
  .main.ai-themed {
    background: linear-gradient(rgba(13, 13, 15, 0.88), rgba(13, 13, 15, 0.88)), url(https://picsum.photos/seed/cyberpunk/1200/900);
    background-size: cover;
    background-position: center;
  }

  /* Responsive */
  @media (max-width: 1100px){
    .app{
      grid-template-columns: 1fr;
      grid-template-areas:
      "header"
      "main"
      "left"
      "right"
      "footer";
    }
  }
</style>
</head>
<body>
  <div class="app">

    <div class="panel header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="text-rainbow" style="font-size:18px; font-weight:900;">Persona Duel</div>
          <div style="font-size:12px; opacity:.9; color:var(--muted);">Neon Pink • Dark Mode</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="pill" id="togglePip"><span class="dot"></span>Launch PiP Browser</button>
        <button class="pill" id="saveLayout"><span class="dot" style="background:var(--brand1); box-shadow: 0 0 6px var(--brand1);"></span>Save Layout</button>
      </div>
    </div>

    <aside class="panel left">
      <div class="section">
        <h3>APIs &amp; Tools</h3>
        <div class="field">
          <label for="handyKey">Handy API Key</label>
          <input id="handyKey" type="password" placeholder="••••••••••" />
        </div>
        <div class="field">
          <label for="elevenKey">ElevenLabs API Key</label>
          <input id="elevenKey" type="password" placeholder="••••••••••" />
        </div>
        <div class="field">
          <label for="imageKey">Image Generator API Key</label>
          <input id="imageKey" type="password" placeholder="••••••••••" />
        </div>

        <div class="divider"></div>

        <h3>PiP Browser</h3>
        <div class="field small">Click “Launch PiP Browser” above, then drag to move, drag the corner to resize.</div>
        <div class="row">
          <input id="pipUrl" type="text" placeholder="https://example.com" />
          <button id="openUrl" class="action primary">Open</button>
        </div>
      </div>
    </aside>

    <main class="panel main">
      <div class="chat" id="chat">
        <div class="msg">
          <b>System</b><br/>Welcome to Persona Duel (Neon Black theme). UI-only: no backend required. ✨
          <div class="tiny">Tip: right sidebar → create persona; bottom → rate with ± stars.</div>
        </div>
        <div class="msg you">
          <b>You</b><br/>“Let’s make it neon, pink and black.”
          <div class="tiny">Delivered</div>
        </div>
      </div>

      <div class="panel composer">
        <button class="iconbtn" title="Attach">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M16.5 6.5l-7.8 7.8a3 3 0 104.2 4.2l7.3-7.3a5 5 0 10-7.1-7.1L5.8 11.4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <input id="composerInput" type="text" placeholder="Type a message… or hold mic" />
        <button class="iconbtn" title="Voice (mic)" id="micBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="9" y="3" width="6" height="10" rx="3" stroke-width="2"/>
            <path d="M5 10a7 7 0 0014 0M12 17v4M8 21h8" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="send">Send</button>
      </div>

      <div class="rating panel">
        <div class="label">Rate response (saves to Memory):</div>
        <button class="star" data-score="-5" data-sign="neg"><span class="num">−5</span></button>
        <button class="star" data-score="-4" data-sign="neg"><span class="num">−4</span></button>
        <button class="star" data-score="-3" data-sign="neg"><span class="num">−3</span></button>
        <button class="star" data-score="-2" data-sign="neg"><span class="num">−2</span></button>
        <button class="star" data-score="-1" data-sign="neg"><span class="num">−1</span></button>
        <button class="star" data-score="1"><span class="num">+1</span></button>
        <button class="star" data-score="2"><span class="num">+2</span></button>
        <button class="star" data-score="3"><span class="num">+3</span></button>
        <button class="star" data-score="4"><span class="num">+4</span></button>
        <button class="star" data-score="5"><span class="num">+5</span></button>
      </div>

      <div class="dropzone panel" id="funsDrop">
        <div class="leftrow">
          <div style="width:36px;height:36px;border-radius:12px;" class="rainbow"></div>
          <div>
            <b>FunScript Library</b><br>
            <span class="hint">Click, drag &amp; drop, or paste to add .funscript files to History.</span>
          </div>
        </div>
        <div class="row" style="flex:0 0 auto;">
          <button class="chipbtn" id="browseFuns">Add Files</button>
          <input id="funsInput" type="file" accept=".funscript,.json" multiple style="display:none" />
        </div>
        <div class="statusline" id="funsDropStatus" aria-live="polite"></div>
      </div>
    </main>

    <aside class="panel right">
      <div class="section funscripts-panel">
        <div class="funscripts-header">
          <h3>FunScript Catalog</h3>
          <button class="chipbtn" id="refreshFunscripts" type="button">Refresh</button>
        </div>
        <div class="small muted">Uploads are analyzed in the background. Cached summaries update as processing completes.</div>
        <div id="funscriptsList" class="funscripts-list">
          <div class="small muted">No FunScripts cataloged yet.</div>
        </div>
      </div>
      <div class="section persona-card">
        <h3>Persona Creator</h3>
        <div class="field">
          <label for="personaName">Persona Name</label>
          <input id="personaName" type="text" placeholder="e.g., Nova, Jett, Kiri" />
        </div>
        <div class="row">
          <div class="field">
            <label for="personaRole">Character</label>
            <input id="personaRole" type="text" placeholder="e.g., witty hacker, stoic bodyguard" />
          </div>
          <div class="field">
            <label for="personaBody">Body Type</label>
            <select id="personaBody">
              <option value="thick">Thick</option>
              <option value="skinny">Skinny</option>
              <option value="big-bust">Big bust</option>
              <option value="small-bust">Small bust</option>
              <option value="monster-booty">Monster booty</option>
              <option value="athletic">Athletic</option>
              <option value="curvy">Curvy</option>
              <option value="petite">Petite</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label for="personaDesc">Description</label>
          <textarea id="personaDesc" rows="3" placeholder="Voice, quirks, boundaries, specialties…"></textarea>
        </div>
        <div class="field">
          <label for="personaGoal">Goal</label>
          <textarea id="personaGoal" rows="2" placeholder="Primary mission or KPI…"></textarea>
        </div>
        <div class="row">
          <button id="addPersona" class="action primary">Create Persona</button>
          <button id="clearPersona" class="action ghost">Reset</button>
        </div>

        <div class="divider"></div>

        <div class="collapser" id="agentsToggle" data-open="true" aria-controls="agentsList">
          <strong>Agents Made</strong>
          <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="collapsible agents" id="agentsList" data-open="true">
          <div class="small">No agents yet — create one above.</div>
        </div>

        <div class="divider"></div>

        <h3>Character Portrait</h3>
        <div class="small">Generate an image for your character (hook up model later).</div>
        <div class="row">
          <button class="action primary">Generate Portrait</button>
          <button class="action ghost">Upload</button>
        </div>

        <div class="divider"></div>

        <div class="toggle">
          <div>
            <b>Battle Mode</b><br>
            <span class="small">AIs take turns “driving”.</span>
          </div>
          <div class="switch" id="battleSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="divider"></div>

        <h3>View the Vibe</h3>
        <div class="small">Aesthetic tuner for the UI theme.</div>
        <div class="row">
          <input type="range" min="0" max="100" value="60" id="vibeSlider" />
          <button class="action ghost" id="vibeRandom">Shuffle</button>
        </div>
        
        <div class="divider"></div>

        <h3>AI Control</h3>
        <div class="toggle">
          <div>
            <b>Dynamic Theme</b><br>
            <span class="small">AI sets UI colors & chat background.</span>
          </div>
          <div class="switch" id="aiThemeSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>
        
      </div>
    </aside>

    <div class="panel footer">
      <div class="status">Layout ready • UI elements are interactive (no backend).</div>
      <div class="eq" aria-label="vibe visualizer"></div>
    </div>
  </div>

  <div class="pip" id="pip">
    <div class="bar" id="pipDrag">
      <div class="title">PiP Browser</div>
      <div class="row" style="gap:6px; align-items:center;">
        <button class="action ghost" id="pipMin">Min</button>
        <button class="action" id="pipClose">Close</button>
      </div>
    </div>
    <iframe id="pipFrame" src="about:blank" title="PiP Browser"></iframe>
    <div class="resize" id="pipResize" aria-hidden="true"></div>
  </div>

<script>
  // Utility toast
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position = 'fixed';
    t.style.left = '50%';
    t.style.bottom = '26px';
    t.style.transform = 'translateX(-50%)';
    t.style.background = 'linear-gradient(90deg, #ff00a0, #00ffff)';
    t.style.color = 'white';
    t.style.textShadow = '0 1px 3px #000';
    t.style.padding = '10px 16px';
    t.style.borderRadius = '10px';
    t.style.zIndex = 9999;
    t.style.fontWeight = '800';
    t.style.border = '1px solid rgba(255,255,255,.3)';
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 1400);
  }

  // Collapser
  const agentsToggle = document.getElementById('agentsToggle');
  const agentsList = document.getElementById('agentsList');
  agentsToggle?.addEventListener('click', ()=>{
    const open = agentsToggle.getAttribute('data-open') === 'true';
    agentsToggle.setAttribute('data-open', (!open).toString());
    agentsList.setAttribute('data-open', (!open).toString());
  });

  // Create persona
  const addPersona = document.getElementById('addPersona');
  const clearPersona = document.getElementById('clearPersona');
  addPersona?.addEventListener('click', ()=>{
    const name  = document.getElementById('personaName').value.trim() || 'Unnamed';
    const role  = document.getElementById('personaRole').value.trim();
    const body  = document.getElementById('personaBody').value;
    const desc  = document.getElementById('personaDesc').value.trim();
    const goal  = document.getElementById('personaGoal').value.trim();

    const wrap = document.createElement('div');
    wrap.className = 'agent';
    const left = document.createElement('div');
    left.innerHTML = '<b>'+name+'</b><div class="small">'+(role ? role+' • ' : '')+body.replace('-', ' ')+'</div>';
    const right = document.createElement('div');
    const use = document.createElement('button');
    use.className = 'action primary'; use.textContent = 'Use';
    right.appendChild(use);
    wrap.appendChild(left); wrap.appendChild(right);

    // Replace placeholder message if present
    const placeholder = agentsList.querySelector('.small');
    if(placeholder && agentsList.children.length === 1){ placeholder.remove(); }
    agentsList.appendChild(wrap);
    toast('Agent “'+name+'” added');
  });
  clearPersona?.addEventListener('click', ()=>{
    ['personaName','personaRole','personaDesc','personaGoal'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('personaBody').selectedIndex = 0;
  });

  // Battle switch
  const battleSwitch = document.getElementById('battleSwitch');
  battleSwitch?.addEventListener('click', ()=>{
    const on = battleSwitch.getAttribute('data-on') === 'true';
    battleSwitch.setAttribute('data-on', (!on).toString());
    battleSwitch.setAttribute('aria-checked', (!on).toString());
    toast('Battle Mode: ' + (!on ? 'ON' : 'OFF'));
  });

  // Stars rating (−5..−1, +1..+5)
  const stars = Array.from(document.querySelectorAll('.star'));
  stars.forEach(btn => btn.addEventListener('click', () => {
    stars.forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    const score = btn.getAttribute('data-score');
    // Simulate write to memory
    toast('Saved rating ' + score + ' to Memory');
  }));

  // Dropzone (FunScript) & Catalog UI
  const drop = document.getElementById('funsDrop');
  const dropStatus = document.getElementById('funsDropStatus');
  const browse = document.getElementById('browseFuns');
  const finput = document.getElementById('funsInput');
  const funsList = document.getElementById('funscriptsList');
  const refreshFuns = document.getElementById('refreshFunscripts');
  const funscriptState = new Map();
  let funscriptPollTimer = null;
  let funscriptLastFetchFailed = false;
  let uploadTempCounter = 0;

  const STATUS_LABELS = {
    ready: 'Ready',
    processing: 'Processing',
    queued: 'Queued',
    uploading: 'Uploading',
    error: 'Error'
  };

  function normalizeEntry(raw){
    if(!raw) return raw;
    const entry = { ...raw };
    entry.tags = Array.isArray(entry.tags) ? [...entry.tags] : [];
    entry.patterns = Array.isArray(entry.patterns) ? [...entry.patterns] : [];
    const analysis = (raw.analysis && typeof raw.analysis === 'object') ? { ...raw.analysis } : {};
    if(typeof analysis.metrics !== 'object' || analysis.metrics === null) analysis.metrics = {};
    if(typeof analysis.stale !== 'boolean') analysis.stale = raw.status !== 'ready';
    if(!('summary' in analysis)) analysis.summary = null;
    if(!('generated_at' in analysis)) analysis.generated_at = null;
    entry.analysis = analysis;
    entry.favorite = Boolean(raw.favorite);
    entry.duration_seconds = typeof raw.duration_seconds === 'number' ? raw.duration_seconds : null;
    entry.action_count = typeof raw.action_count === 'number' ? raw.action_count : null;
    entry.error = raw.error || null;
    entry.status = (raw.status || 'queued').toLowerCase();
    return entry;
  }

  function setDropStatus(message, loading=false){
    if(dropStatus){ dropStatus.textContent = message || ''; }
    if(drop){
      if(loading){ drop.setAttribute('data-loading', 'true'); }
      else { drop.removeAttribute('data-loading'); }
    }
  }

  function formatDuration(seconds){
    if(typeof seconds !== 'number' || Number.isNaN(seconds)) return '–';
    const total = Math.max(0, Math.round(seconds));
    const mins = Math.floor(total / 60);
    const secs = total % 60;
    if(mins && secs) return `${mins}m ${secs}s`;
    if(mins) return `${mins}m`;
    return `${secs}s`;
  }

  function formatDateTime(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return '';
    return d.toLocaleString();
  }

  function renderFunscripts(){
    if(!funsList) return;
    const items = Array.from(funscriptState.values());
    funsList.innerHTML = '';
    if(!items.length){
      const empty = document.createElement('div');
      empty.className = 'small muted';
      empty.textContent = 'No FunScripts cataloged yet.';
      funsList.appendChild(empty);
      return;
    }

    items.sort((a, b) => {
      const aTime = Date.parse(a.updated_at || a.created_at || '') || 0;
      const bTime = Date.parse(b.updated_at || b.created_at || '') || 0;
      return bTime - aTime;
    });

    items.forEach(item => {
      const card = document.createElement('div');
      const statusKey = (item.optimistic ? 'uploading' : item.status || 'queued').toLowerCase();
      card.className = 'funscript-item';
      card.dataset.status = statusKey;

      const meta = document.createElement('div');
      meta.className = 'funscript-meta';

      const titleWrap = document.createElement('div');
      const title = document.createElement('h4');
      title.textContent = item.name || 'Unnamed FunScript';
      titleWrap.appendChild(title);

      const statusChip = document.createElement('div');
      statusChip.className = `funscript-status ${statusKey}`;
      statusChip.textContent = STATUS_LABELS[statusKey] || (item.status || 'Queued');

      meta.appendChild(titleWrap);
      meta.appendChild(statusChip);
      card.appendChild(meta);

      const detailBits = [];
      if(typeof item.duration_seconds === 'number') detailBits.push(`Duration ${formatDuration(item.duration_seconds)}`);
      if(typeof item.action_count === 'number' && item.action_count > 0) detailBits.push(`${item.action_count} actions`);
      if(item.analysis && item.analysis.generated_at){
        const formatted = formatDateTime(item.analysis.generated_at);
        if(formatted) detailBits.push(`Last analyzed ${formatted}`);
      }
      if(detailBits.length){
        const info = document.createElement('div');
        info.className = 'funscript-details';
        info.textContent = detailBits.join(' • ');
        card.appendChild(info);
      }

      if(item.patterns && item.patterns.length){
        const patternInfo = document.createElement('div');
        patternInfo.className = 'funscript-details';
        patternInfo.textContent = `Patterns: ${item.patterns.join(', ')}`;
        card.appendChild(patternInfo);
      }

      const analysis = item.analysis || {};
      if(analysis.summary){
        const summary = document.createElement('div');
        summary.className = 'small';
        summary.textContent = analysis.summary + (analysis.stale && statusKey !== 'ready' ? ' (cached)' : '');
        card.appendChild(summary);
      } else if(statusKey === 'ready'){
        const summary = document.createElement('div');
        summary.className = 'small muted';
        summary.textContent = 'Analysis pending…';
        card.appendChild(summary);
      }

      if(statusKey === 'error' && item.error){
        const err = document.createElement('div');
        err.className = 'error-text';
        err.textContent = item.error;
        card.appendChild(err);
      }

      const tagsWrap = document.createElement('div');
      tagsWrap.className = 'funscript-tags';
      if(item.tags && item.tags.length){
        item.tags.forEach(tag => {
          const tagBtn = document.createElement('button');
          tagBtn.type = 'button';
          tagBtn.className = 'tagchip';
          tagBtn.dataset.action = 'remove-tag';
          tagBtn.dataset.id = item.id;
          tagBtn.dataset.tag = tag;
          tagBtn.textContent = `#${tag}`;
          tagsWrap.appendChild(tagBtn);
        });
      } else {
        const noTag = document.createElement('div');
        noTag.className = 'small muted';
        noTag.textContent = 'No tags yet.';
        tagsWrap.appendChild(noTag);
      }
      card.appendChild(tagsWrap);

      const actions = document.createElement('div');
      actions.className = 'funscript-actions';

      const tagBtn = document.createElement('button');
      tagBtn.type = 'button';
      tagBtn.className = 'chipbtn';
      tagBtn.dataset.action = 'tag';
      tagBtn.dataset.id = item.id;
      tagBtn.textContent = 'Add tag';
      actions.appendChild(tagBtn);

      const favBtn = document.createElement('button');
      favBtn.type = 'button';
      favBtn.className = 'chipbtn favorite-btn' + (item.favorite ? ' active' : '');
      favBtn.dataset.action = 'favorite';
      favBtn.dataset.id = item.id;
      favBtn.dataset.favorite = item.favorite ? 'true' : 'false';
      favBtn.textContent = item.favorite ? '★ Favorite' : '☆ Favorite';
      actions.appendChild(favBtn);

      const reBtn = document.createElement('button');
      reBtn.type = 'button';
      reBtn.className = 'chipbtn';
      reBtn.dataset.action = 'reanalyze';
      reBtn.dataset.id = item.id;
      const waiting = ['processing','queued','uploading'].includes(statusKey);
      reBtn.disabled = waiting;
      reBtn.textContent = waiting ? 'Re-analyze (pending)' : 'Re-analyze';
      actions.appendChild(reBtn);

      card.appendChild(actions);
      funsList.appendChild(card);
    });
  }

  function filterFunScriptFiles(list){
    return Array.from(list || []).filter(file => /\.(funscript|json)$/i.test(file.name || ''));
  }

  async function fetchFunscripts(manual=false){
    try {
      const resp = await fetch('/api/funscripts');
      if(!resp.ok){
        const text = await resp.text();
        throw new Error(text || 'Request failed');
      }
      const data = await resp.json();
      const optimistic = Array.from(funscriptState.entries()).filter(([, value]) => value.optimistic);
      funscriptState.clear();
      if(data && Array.isArray(data.items)){
        data.items.forEach(item => {
          const normalized = normalizeEntry(item);
          funscriptState.set(normalized.id, normalized);
        });
      }
      optimistic.forEach(([id, entry]) => funscriptState.set(id, entry));
      renderFunscripts();
      if(funscriptLastFetchFailed && !manual){
        toast('FunScript status reconnected');
      }
      funscriptLastFetchFailed = false;
    } catch (err) {
      if(manual || !funscriptLastFetchFailed){
        toast('Failed to refresh FunScripts: ' + (err?.message || err));
      }
      funscriptLastFetchFailed = true;
    }
  }

  async function updateTag(id, tag, mode){
    if(!tag) return;
    try {
      const resp = await fetch(`/api/funscripts/${id}/tag`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag, action: mode === 'remove' ? 'remove' : 'add' })
      });
      if(!resp.ok){
        const text = await resp.text();
        throw new Error(text || 'Failed to update tag');
      }
      const data = await resp.json();
      if(data && data.item){
        const normalized = normalizeEntry(data.item);
        funscriptState.set(normalized.id, normalized);
        renderFunscripts();
        toast(mode === 'remove' ? `Removed #${tag}` : `Tagged #${tag}`);
      }
    } catch (err) {
      toast('Tag update failed: ' + (err?.message || err));
    }
  }

  async function updateFavorite(id, value){
    try {
      const resp = await fetch(`/api/funscripts/${id}/favorite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ favorite: value })
      });
      if(!resp.ok){
        const text = await resp.text();
        throw new Error(text || 'Failed to update favorite');
      }
      const data = await resp.json();
      if(data && data.item){
        const normalized = normalizeEntry(data.item);
        funscriptState.set(normalized.id, normalized);
        renderFunscripts();
        toast(value ? 'Marked favorite' : 'Favorite removed');
      }
    } catch (err) {
      toast('Favorite update failed: ' + (err?.message || err));
    }
  }

  async function requestReanalysis(id){
    try {
      const resp = await fetch(`/api/funscripts/${id}/reanalyze`, { method: 'POST' });
      if(!resp.ok){
        const text = await resp.text();
        throw new Error(text || 'Failed to queue re-analysis');
      }
      const data = await resp.json();
      if(data && data.item){
        const normalized = normalizeEntry(data.item);
        funscriptState.set(normalized.id, normalized);
        renderFunscripts();
        toast('Re-analysis requested');
        fetchFunscripts();
      }
    } catch (err) {
      toast('Re-analysis failed: ' + (err?.message || err));
    }
  }

  function handleSelectedFiles(list){
    const accepted = filterFunScriptFiles(list);
    if(!accepted.length){
      setDropStatus('Only .funscript or .json files are supported.');
      toast('No valid FunScript files detected');
      return;
    }
    setDropStatus(`Uploading ${accepted.length} file${accepted.length > 1 ? 's' : ''}…`, true);
    uploadFunScripts(accepted);
  }

  async function uploadFunScripts(files){
    if(!files.length) return;
    const optimisticEntries = files.map(file => {
      const tempId = `temp-${Date.now()}-${uploadTempCounter++}`;
      const entry = normalizeEntry({
        id: tempId,
        name: file.name,
        status: 'uploading',
        duration_seconds: null,
        patterns: [],
        tags: [],
        favorite: false,
        analysis: { summary: null, generated_at: null, metrics: {}, stale: true },
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      });
      entry.optimistic = true;
      funscriptState.set(tempId, entry);
      return entry;
    });
    renderFunscripts();

    const formData = new FormData();
    files.forEach(file => formData.append('files', file));

    try {
      const resp = await fetch('/api/funscripts', { method: 'POST', body: formData });
      if(!resp.ok){
        const text = await resp.text();
        throw new Error(text || 'Upload failed');
      }
      const data = await resp.json();
      optimisticEntries.forEach(entry => funscriptState.delete(entry.id));
      if(data && Array.isArray(data.items)){
        data.items.forEach(item => {
          const normalized = normalizeEntry(item);
          funscriptState.set(normalized.id, normalized);
        });
      }
      if(data && Array.isArray(data.errors)){
        data.errors.filter(Boolean).forEach(msg => toast(msg));
      }
      renderFunscripts();
      setDropStatus('Files uploaded. Analysis queued.');
      toast(`Queued ${files.length} FunScript${files.length > 1 ? 's' : ''} for analysis`);
      fetchFunscripts();
    } catch (err) {
      optimisticEntries.forEach(entry => funscriptState.delete(entry.id));
      renderFunscripts();
      setDropStatus('Upload failed.');
      toast('Upload failed: ' + (err?.message || err));
    } finally {
      if(drop) drop.removeAttribute('data-loading');
      if(finput) finput.value = '';
    }
  }

  browse?.addEventListener('click', () => finput?.click());
  finput?.addEventListener('change', (e) => {
    if(e.target?.files?.length){ handleSelectedFiles(e.target.files); }
    e.target.value = '';
  });

  ['dragover','dragleave','drop'].forEach(evt => drop?.addEventListener(evt, e => {
    e.preventDefault(); e.stopPropagation();
    if(evt === 'dragover'){
      drop.style.borderColor = 'var(--brand1)';
    }
    if(evt === 'dragleave'){
      drop.style.borderColor = 'rgba(255, 0, 150, 0.5)';
    }
    if(evt === 'drop'){
      drop.style.borderColor = 'rgba(255, 0, 150, 0.5)';
      if(e.dataTransfer?.files?.length){ handleSelectedFiles(e.dataTransfer.files); }
    }
  }));

  document.addEventListener('paste', e => {
    if(e.clipboardData?.files?.length){ handleSelectedFiles(e.clipboardData.files); }
  });

  refreshFuns?.addEventListener('click', () => fetchFunscripts(true));

  funsList?.addEventListener('click', (event) => {
    const target = event.target.closest('[data-action]');
    if(!target) return;
    const id = target.getAttribute('data-id');
    const action = target.getAttribute('data-action');
    if(!id || !action) return;

    if(action === 'tag'){
      const current = funscriptState.get(id);
      const suggested = current?.tags?.[0] ? `Add tag for ${current.name || 'FunScript'}` : `Add tag for ${current?.name || 'FunScript'}`;
      const response = prompt(suggested, '');
      if(!response) return;
      const cleaned = response.trim().replace(/^#/, '');
      if(!cleaned) return;
      updateTag(id, cleaned, 'add');
    } else if(action === 'remove-tag'){
      const tag = target.getAttribute('data-tag');
      if(!tag) return;
      updateTag(id, tag, 'remove');
    } else if(action === 'favorite'){
      const currentFav = target.getAttribute('data-favorite') === 'true';
      updateFavorite(id, !currentFav);
    } else if(action === 'reanalyze'){
      requestReanalysis(id);
    }
  });

  function startFunscriptPolling(){
    if(funscriptPollTimer) clearInterval(funscriptPollTimer);
    funscriptPollTimer = setInterval(() => fetchFunscripts(false), 5000);
  }

  fetchFunscripts();
  startFunscriptPolling();

  // PiP
  const togglePip = document.getElementById('togglePip');
  const pip = document.getElementById('pip');
  const pipClose = document.getElementById('pipClose');
  const pipMin = document.getElementById('pipMin');
  const pipDrag = document.getElementById('pipDrag');
  const pipResize = document.getElementById('pipResize');
  const pipFrame = document.getElementById('pipFrame');
  const openUrl = document.getElementById('openUrl');
  togglePip?.addEventListener('click', ()=>{
    pip.classList.toggle('visible');
  });
  pipClose?.addEventListener('click', ()=> pip.classList.remove('visible'));
  pipMin?.addEventListener('click', ()=>{
    if(pip.style.height !== '60px'){ pip.dataset.prev = JSON.stringify({w:pip.style.width,h:pip.style.height}); pip.style.height = '60px'; }
    else {
      try { const prev = JSON.parse(pip.dataset.prev || '{}'); pip.style.height = prev.h || '240px'; } catch {}
    }
  });
  openUrl?.addEventListener('click', ()=>{
    const url = document.getElementById('pipUrl').value.trim();
    if(!url) return toast('Enter a URL first');
    try {
      const u = new URL(url.match(/^https?:\/\//) ? url : 'https://' + url);
      pipFrame.src = u.href;
      if(!pip.classList.contains('visible')) pip.classList.add('visible');
    } catch { toast('Invalid URL'); }
  });

  // Drag logic
  (function enableDrag(el, handle){
    let ox, oy, left, top; 
    function onDown(e){
      const r = el.getBoundingClientRect();
      left = r.left; top = r.top;
      ox = (e.touches? e.touches[0].clientX : e.clientX) - left;
      oy = (e.touches? e.touches[0].clientY : e.clientY) - top;
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
    }
    function onMove(e){
      const x = (e.touches? e.touches[0].clientX : e.clientX) - ox;
      const y = (e.touches? e.touches[0].clientY : e.clientY) - oy;
      el.style.left = Math.max(8, Math.min(window.innerWidth - el.offsetWidth - 8, x)) + 'px';
      el.style.top  = Math.max(8, Math.min(window.innerHeight - el.offsetHeight - 8, y)) + 'px';
      el.style.right = 'auto'; el.style.bottom = 'auto'; // anchor from left/top once dragged
    }
    function onUp(){
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('mouseup', onUp);
      window.removeEventListener('touchend', onUp);
    }
    handle.addEventListener('mousedown', onDown);
    handle.addEventListener('touchstart', onDown);
  })(pip, pipDrag);

  // Resize logic
  (function enableResize(el, handle){
    let startX, startY, startW, startH;
    function onDown(e){
      startX = (e.touches? e.touches[0].clientX : e.clientX);
      startY = (e.touches? e.touches[0].clientY : e.clientY);
      const r = el.getBoundingClientRect();
      startW = r.width; startH = r.height;
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
    }
    function onMove(e){
      const x = (e.touches? e.touches[0].clientX : e.clientX);
      const y = (e.touches? e.touches[0].clientY : e.clientY);
      let w = Math.max(260, startW + (x - startX));
      let h = Math.max(160, startH + (y - startY));
      el.style.width = w + 'px';
      el.style.height = h + 'px';
    }
    function onUp(){
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('mouseup', onUp);
      window.removeEventListener('touchend', onUp);
    }
    handle.addEventListener('mousedown', onDown);
    handle.addEventListener('touchstart', onDown);
  })(pip, pipResize);

  // Mic button (visual only)
  const micBtn = document.getElementById('micBtn');
  let micOn = false;
  micBtn?.addEventListener('click', ()=>{
    micOn = !micOn;
    micBtn.style.outline = micOn ? '4px solid rgba(255, 0, 150, 0.4)' : 'none';
    micBtn.style.borderColor = micOn ? '#ff00a0' : 'var(--edge)';
    toast('Mic ' + (micOn ? 'listening (UI only)' : 'off'));
  });

  // Save layout (UI only)
  const saveLayout = document.getElementById('saveLayout');
  saveLayout?.addEventListener('click', ()=> toast('Layout saved (stub)'));

  // --- NEW --- AI Theme Control Logic
  const aiThemeSwitch = document.getElementById('aiThemeSwitch');
  const mainPanel = document.querySelector('.main.panel');
  aiThemeSwitch?.addEventListener('click', ()=>{
    const on = aiThemeSwitch.getAttribute('data-on') === 'true';
    aiThemeSwitch.setAttribute('data-on', (!on).toString());
    aiThemeSwitch.setAttribute('aria-checked', (!on).toString());
    mainPanel.classList.toggle('ai-themed', !on);
    toast('AI Dynamic Theme: ' + (!on ? 'ON' : 'OFF'));
  });
</script>
</body>
</html>
