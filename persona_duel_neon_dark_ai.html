<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Persona Duel — Neon Pink & Black</title>
<style>
  :root{
    /*--[ NEON/BLACK THEME ]--*/
    --bg: radial-gradient(circle at 10% 20%, rgba(255, 0, 150, 0.15), transparent 40%),
          radial-gradient(circle at 90% 80%, rgba(0, 255, 255, 0.1), transparent 40%),
          #0d0d0f;
    --glass: rgba(20, 20, 25, 0.5);
    --glass-strong: rgba(30, 30, 35, 0.75);
    --text: #e8e8e8;
    --muted: #888;
    --edge: rgba(255, 0, 150, 0.3);
    --brand1: #ff00a0; /* Neon Pink */
    --brand2: #00ffff; /* Neon Cyan */
    --brand3: #00ff00; /* Neon Green */
    --brand4: #ffff00; /* Neon Yellow */
    --brand5: #c400ff; /* Neon Purple */
    --ok: #20bf55;
    --warn: #ff8c42;
    --bad: #ff4d7e;
    --shadow: 0 0 15px rgba(255, 0, 150, 0.2), 0 0 25px rgba(0, 255, 255, 0.1); /* Neon Glow */
    --ring: 0 0 0 3px rgba(255, 0, 150, 0.4);
    --radius-lg: 20px;
    --radius-md: 14px;
    --radius-sm: 10px;
    --chip: 999px;
  }

  /* Rainbow iridescent helpers */
  .rainbow{
    background: conic-gradient(from 180deg, var(--brand1), var(--brand2), var(--brand3), var(--brand4), var(--brand5), var(--brand1));
  }
  .text-rainbow{
    background: linear-gradient(90deg,var(--brand1),var(--brand2),var(--brand3),var(--brand4),var(--brand5));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 0 8px rgba(255, 0, 150, 0.5);
  }

  html, body { height: 100%; }
  body{
    margin:0;
    font-family: ui-rounded, "SF Pro Rounded", "Nunito", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color: var(--text);
    background: var(--bg);
    background-attachment: fixed;
  }
  
  ::placeholder{ color: #555; }

  /* Layout */
  .app{
    display: grid;
    grid-template-columns: 320px 1fr 360px;
    grid-template-rows: auto 1fr auto;
    grid-template-areas:
      "left header right"
      "left main   right"
      "left footer right";
    gap: 16px;
    padding: 16px;
    min-height: 100vh;
    box-sizing: border-box;
  }

  .panel{
    background: var(--glass);
    backdrop-filter: blur(12px) saturate(1.2);
    border: 1px solid var(--edge);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    position: relative;
    transition: background .5s;
  }

  .header{
    grid-area: header;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    font-weight: 800;
    letter-spacing:.2px;
    font-size: 18px;
  }
  .logo{
    width:38px;height:38px;border-radius: 11px; position:relative; overflow:hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12), inset 0 0 0 1px var(--edge);
  }
  .logo:before{ content:""; position:absolute; inset:0; background: conic-gradient(from 200deg, var(--brand1), var(--brand2), var(--brand3), var(--brand4), var(--brand5), var(--brand1)); animation: spin 6s linear infinite; }
  .logo:after{ content:""; position:absolute; inset:3px; border-radius:9px; background: rgba(15,15,20,.9); }
  @keyframes spin { to { transform: rotate(360deg);} }

  .header-actions{
    display:flex; gap:10px; align-items:center;
  }
  .pill{
    border: 1px solid var(--edge); padding:10px 14px; border-radius: var(--chip);
    background: rgba(10,10,10,.5);
    color: var(--text);
    display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:700;
  }
  .pill:hover { filter: brightness(1.2); }
  .pill .dot{ width:8px; height:8px; border-radius:50%; background: var(--brand2); box-shadow: 0 0 6px var(--brand2); }

  /* Sidebars */
  .left{ grid-area: left; display:flex; flex-direction:column; gap:16px; }
  .right{ grid-area: right; display:flex; flex-direction:column; gap:16px; }

  .section{ padding: 14px 16px; }
  .section h3{ margin: 10px 0; font-size: 14px; letter-spacing:.3px; text-transform: uppercase; color: #f0c0e0; text-shadow: 0 0 5px var(--brand1); }
  .field{ display:flex; flex-direction:column; gap:6px; margin-bottom: 10px; }
  label{ font-size:12px; color:#ccc; font-weight: 700; letter-spacing:.2px; }
  input[type="text"], input[type="password"], textarea, select{
    border-radius: 12px; border: 1px solid rgba(255,255,255,.1);
    padding: 10px 12px;
    background: rgba(0,0,0,.3);
    outline: none;
    color: var(--text);
  }
  input:focus, textarea:focus, select:focus{ box-shadow: var(--ring); border-color: var(--brand1); }

  .row{ display:flex; gap:10px; }
  .row > *{ flex:1; }

  .toggle{
    display:flex; align-items:center; gap:10px;
    justify-content: space-between;
    background: rgba(0,0,0,.3);
    border:1px solid rgba(255,255,255,.1);
    padding:10px 12px;border-radius: 12px;
  }
  .switch{ position:relative; width:48px; height:28px; background:#333; border-radius: 999px; transition:.25s; cursor: pointer; }
  .switch:before{
    content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:#111;
    box-shadow: 0 2px 6px rgba(0,0,0,.5); transition:.25s;
  }
  .switch[data-on="true"]{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); box-shadow: 0 0 8px var(--brand1); }
  .switch[data-on="true"]::before{ left:23px; background: white; }

  /* Main center */
  .main{ grid-area: main; display:grid; grid-template-rows: 1fr auto auto; gap:12px; }
  .chat{
    padding:16px;
    display:flex; flex-direction:column; gap:12px; overflow-y: auto;
  }
  .msg{
    max-width: 70%;
    padding:12px 14px; border-radius: 16px; background: rgba(20, 25, 30, 0.7); border:1px solid rgba(255, 0, 150, 0.2);
    box-shadow: 0 4px 10px rgba(0,0,0,.2);
  }
  .msg.you{ margin-left:auto; background: linear-gradient(135deg, rgba(255, 0, 150, 0.2), rgba(255, 0, 150, 0.1)); }
  .msg .tiny{ font-size:11px; color: var(--muted); margin-top:6px; }

  .composer{ display:flex; gap:10px; padding: 10px 12px; align-items:center; }
  .composer input[type="text"]{
    flex:1; padding:12px 14px; border-radius: 999px; border:1px solid rgba(255,255,255,.1); background: rgba(0,0,0,.3);
  }
  .iconbtn{
    border:1px solid var(--edge); background: rgba(10,10,10,.5); border-radius: 999px; width:44px; height:44px; display:grid; place-items:center; cursor:pointer;
  }
  .iconbtn svg path, .iconbtn svg rect { stroke: #bbb; }
  .iconbtn:hover { filter: brightness(1.2); }
  .send{ padding: 12px 18px; border:none; border-radius: 999px; background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:white; font-weight:800; letter-spacing:.3px; box-shadow: 0 2px 8px rgba(0,0,0,.4); cursor:pointer; transition: .2s; }
  .send:hover{ filter: brightness(1.2); box-shadow: 0 0 10px var(--brand1); }

  .rating{
    display:flex; flex-wrap: wrap; gap:8px; padding: 0 14px 12px 14px; align-items:center;
  }
  .rating .label{ font-size:12px; font-weight:800; letter-spacing:.3px; color:#ccc; margin-right:8px; }
  .star{
    --accent: #00ffff;
    position: relative;
    display:inline-grid; place-items:center;
    width:36px; height:36px; border-radius: 10px;
    background: rgba(10,10,10,.5);
    border: 1px solid var(--edge);
    cursor:pointer;
    font-weight: 900;
    font-size: 12px;
    color:var(--text);
  }
  .star[data-sign="neg"]{ --accent: #ff00a0; }
  .star.active{
    outline: 3px solid rgba(0,0,0,0);
    box-shadow: 0 0 12px color-mix(in oklab, var(--accent) 80%, transparent), 0 0 0 3px color-mix(in oklab, var(--accent) 50%, transparent);
  }
  .star .num{ position:relative; z-index:1; }

  .dropzone{
    margin: 8px 14px 16px 14px;
    border: 2px dashed rgba(255, 0, 150, 0.5);
    border-radius: var(--radius-md);
    padding: 16px;
    background: rgba(0,0,0,0.2);
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }
  .dropzone.loading{
    border-color: var(--brand2);
    box-shadow: 0 0 12px rgba(0, 255, 255, 0.35);
  }
  .dropzone .hint{ color: var(--muted); font-size: 12px; }
  .dropzone .chipbtn{
    border: 1px solid var(--edge); border-radius: var(--chip);
    background: rgba(10,10,10,.5); color: var(--text);
    padding:10px 14px; cursor:pointer; font-weight:800;
  }
  .dropzone .chipbtn:hover { filter: brightness(1.2); }

  .funs-library{
    margin-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
    padding-top: 12px;
    width: 100%;
    display:flex;
    flex-direction: column;
    gap: 10px;
  }
  .funs-status{
    font-size: 12px;
    color: var(--muted);
    letter-spacing: .2px;
  }
  .funs-status[data-state="success"]{ color: var(--brand2); }
  .funs-status[data-state="error"]{ color: var(--bad); }
  .funs-status[data-state="warn"]{ color: var(--warn); }
  .funs-list{
    display:flex;
    flex-direction: column;
    gap: 10px;
    max-height: 220px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .funs-card{
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: var(--radius-md);
    padding: 10px 12px;
    background: rgba(0,0,0,0.35);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
  }
  .funs-card .title{ font-weight: 700; letter-spacing: .3px; margin-bottom: 4px; }
  .funs-card .meta{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; }
  .funs-card .summary{ font-size: 12px; margin-top: 6px; line-height: 1.4; }
  .funs-tags{ display:flex; flex-wrap:wrap; gap:6px; margin-top: 6px; }
  .funs-tag{ font-size: 10px; text-transform: uppercase; background: rgba(255,255,255,0.08); padding:3px 8px; border-radius: var(--chip); letter-spacing:.5px; }

  /* PiP Browser (draggable + resizable) */
  .pip{
    position: fixed;
    right: 30px; bottom: 30px;
    width: 380px; height: 240px; z-index: 5;
    background: rgba(15,15,20,.95);
    border: 1px solid var(--edge);
    border-radius: 16px;
    box-shadow: 0 15px 40px rgba(0,0,0,.5), 0 0 15px var(--brand1);
    overflow:hidden;
    display:none;
  }
  .pip.visible{ display:block; }
  .pip .bar{
    height: 40px; display:flex; align-items:center; justify-content:space-between; padding: 0 12px;
    background: linear-gradient(90deg, rgba(20,20,25,.9), rgba(20,20,25,.75));
    cursor: move;
  }
  .pip .bar .title{ font-weight:800; letter-spacing:.3px; }
  .pip iframe{
    border:0; width:100%; height: calc(100% - 40px);
    background: #111;
  }
  .pip .resize{
    position:absolute; width:16px; height:16px; right:8px; bottom:8px; cursor: nwse-resize;
    background: conic-gradient(from 45deg, #666 0 25%, transparent 0 50%, #666 0 75%, transparent 0 100%);
    opacity:.8;
  }

  .persona-preview{
    position: fixed;
    right: 32px;
    bottom: 32px;
    width: 280px;
    background: var(--glass-strong);
    border-radius: var(--radius-lg);
    border: 1px solid var(--edge);
    box-shadow: var(--shadow);
    backdrop-filter: blur(18px) saturate(1.2);
    overflow: hidden;
    transform: translateY(20px);
    opacity: 0;
    pointer-events: none;
    transition: transform .25s ease, opacity .25s ease;
    z-index: 8;
  }
  .persona-preview.visible{
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }
  .persona-preview img{
    width: 100%;
    height: 160px;
    object-fit: cover;
    display: block;
  }
  .persona-preview .content{
    padding: 14px;
    display: grid;
    gap: 6px;
  }
  .persona-preview .title{
    font-weight: 800;
    font-size: 16px;
    letter-spacing: .3px;
  }
  .persona-preview .meta{
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .4px;
    color: rgba(255, 255, 255, 0.65);
  }
  .persona-preview .desc{
    font-size: 12px;
    line-height: 1.4;
    color: var(--muted);
  }
  .persona-preview button.close{
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.45);
    color: var(--text);
    font-weight: 700;
    cursor: pointer;
    transition: filter .2s ease;
  }
  .persona-preview button.close:hover{ filter: brightness(1.3); }

  /* Persona Creator */
  .persona-card{ display:flex; flex-direction:column; gap:10px; }
  .small{ font-size:12px; color: var(--muted); }

  .divider{ height: 1px; background: linear-gradient(90deg, transparent, var(--edge), transparent); margin: 10px 0; }

  .agents{
    display:flex; flex-direction:column; gap:10px;
  }
  .agent{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px; border-radius:12px; background: rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.08);
  }
  .collapser{ cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 12px; border-radius: 12px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); }
  .collapser .arrow{ transition:.25s; }
  .collapser[data-open="true"] .arrow{ transform: rotate(180deg); }
  .collapser svg path { stroke: #bbb; }
  .collapsible{ display:none; }
  .collapsible[data-open="true"]{ display:block; }

  .action{ border:none; padding:10px 12px; border-radius: 12px; font-weight: 800; letter-spacing:.2px; cursor:pointer; box-shadow: 0 2px 8px rgba(0,0,0,.4); transition: .2s; }
  .action:hover{ filter: brightness(1.2); }
  .primary{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); color:white; }
  .primary:hover{ box-shadow: 0 0 10px var(--brand1); }
  .ghost{ background: transparent; border: 1px solid var(--brand1); color: var(--brand1); }
  .ghost:hover{ background: var(--brand1); color: white; box-shadow: 0 0 10px var(--brand1); }

  /* Footer */
  .footer{ grid-area: footer; display:flex; align-items:center; justify-content: space-between; padding: 12px 16px; }
  .footer .status{ font-size:12px; color: var(--muted); }
  .eq{
    height:12px; width: 170px; border-radius:999px; background: rgba(0,0,0,.3); border:1px solid var(--edge);
    position:relative; overflow:hidden;
  }
  .eq:before{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, var(--brand1), var(--brand2), var(--brand3), var(--brand4), var(--brand5));
    animation: slide 4s linear infinite; width: 200%;
  }
  @keyframes slide {
    0% { transform: translateX(-50%); }
    100% { transform: translateX(0%); }
  }

  /* --- NEW --- AI Theme Style */
  .main.ai-themed {
    background: linear-gradient(rgba(13, 13, 15, 0.88), rgba(13, 13, 15, 0.88)), url(https://picsum.photos/seed/cyberpunk/1200/900);
    background-size: cover;
    background-position: center;
  }

  /* Responsive */
  @media (max-width: 1100px){
    .app{
      grid-template-columns: 1fr;
      grid-template-areas:
      "header"
      "main"
      "left"
      "right"
      "footer";
    }
  }
</style>
</head>
<body>
  <div class="app">

    <div class="panel header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="text-rainbow" style="font-size:18px; font-weight:900;">Persona Duel</div>
          <div style="font-size:12px; opacity:.9; color:var(--muted);">Neon Pink • Dark Mode</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="pill" id="togglePip"><span class="dot"></span>Launch PiP Browser</button>
        <button class="pill" id="saveLayout"><span class="dot" style="background:var(--brand1); box-shadow: 0 0 6px var(--brand1);"></span>Save Layout</button>
      </div>
    </div>

    <aside class="panel left">
      <div class="section">
        <h3>APIs &amp; Tools</h3>
        <div class="field">
          <label for="handyKey">Handy API Key</label>
          <input id="handyKey" type="password" placeholder="••••••••••" />
        </div>
        <div class="field">
          <label for="elevenKey">ElevenLabs API Key</label>
          <input id="elevenKey" type="password" placeholder="••••••••••" />
        </div>
        <div class="field">
          <label for="imageKey">Image Generator API Key</label>
          <input id="imageKey" type="password" placeholder="••••••••••" />
        </div>

        <div class="divider"></div>

        <h3>PiP Browser</h3>
        <div class="field small">Click “Launch PiP Browser” above, then drag to move, drag the corner to resize.</div>
        <div class="row">
          <input id="pipUrl" type="text" placeholder="https://example.com" />
          <button id="openUrl" class="action primary">Open</button>
        </div>
      </div>
    </aside>

    <main class="panel main">
      <div class="chat" id="chat">
        <div class="msg">
          <b>System</b><br/>Welcome to Persona Duel (Neon Black theme). UI-only: no backend required. ✨
          <div class="tiny">Tip: right sidebar → create persona; bottom → rate with ± stars.</div>
        </div>
        <div class="msg you">
          <b>You</b><br/>“Let’s make it neon, pink and black.”
          <div class="tiny">Delivered</div>
        </div>
      </div>

      <div class="panel composer">
        <button class="iconbtn" title="Attach">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M16.5 6.5l-7.8 7.8a3 3 0 104.2 4.2l7.3-7.3a5 5 0 10-7.1-7.1L5.8 11.4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <input id="composerInput" type="text" placeholder="Type a message… or hold mic" />
        <button class="iconbtn" title="Voice (mic)" id="micBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="9" y="3" width="6" height="10" rx="3" stroke-width="2"/>
            <path d="M5 10a7 7 0 0014 0M12 17v4M8 21h8" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="send">Send</button>
      </div>

      <div class="rating panel">
        <div class="label">Rate response (saves to Memory):</div>
        <button class="star" data-score="-5" data-sign="neg"><span class="num">−5</span></button>
        <button class="star" data-score="-4" data-sign="neg"><span class="num">−4</span></button>
        <button class="star" data-score="-3" data-sign="neg"><span class="num">−3</span></button>
        <button class="star" data-score="-2" data-sign="neg"><span class="num">−2</span></button>
        <button class="star" data-score="-1" data-sign="neg"><span class="num">−1</span></button>
        <button class="star" data-score="1"><span class="num">+1</span></button>
        <button class="star" data-score="2"><span class="num">+2</span></button>
        <button class="star" data-score="3"><span class="num">+3</span></button>
        <button class="star" data-score="4"><span class="num">+4</span></button>
        <button class="star" data-score="5"><span class="num">+5</span></button>
      </div>

      <div class="dropzone panel" id="funsDrop">
        <div class="leftrow">
          <div style="width:36px;height:36px;border-radius:12px;" class="rainbow"></div>
          <div>
            <b>FunScript Library</b><br>
            <span class="hint">Click, drag &amp; drop, or paste to add .funscript files to History.</span>
          </div>
        </div>
        <div class="row" style="flex:0 0 auto;">
          <button class="chipbtn" id="browseFuns">Add Files</button>
          <input id="funsInput" type="file" accept=".funscript,.json" multiple style="display:none" />
        </div>
        <div class="funs-library" id="funsLibrary">
          <div class="funs-status" id="funsStatus" data-state="idle">No FunScripts uploaded yet.</div>
          <div class="funs-list" id="funsList"></div>
        </div>
      </div>
    </main>

    <aside class="panel right">
      <div class="section persona-card">
        <h3>Persona Creator</h3>
        <div class="field">
          <label for="personaName">Persona Name</label>
          <input id="personaName" type="text" placeholder="e.g., Nova, Jett, Kiri" />
        </div>
        <div class="row">
          <div class="field">
            <label for="personaRole">Character</label>
            <input id="personaRole" type="text" placeholder="e.g., witty hacker, stoic bodyguard" />
          </div>
          <div class="field">
            <label for="personaBody">Body Type</label>
            <select id="personaBody">
              <option value="thick">Thick</option>
              <option value="skinny">Skinny</option>
              <option value="big-bust">Big bust</option>
              <option value="small-bust">Small bust</option>
              <option value="monster-booty">Monster booty</option>
              <option value="athletic">Athletic</option>
              <option value="curvy">Curvy</option>
              <option value="petite">Petite</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label for="personaDesc">Description</label>
          <textarea id="personaDesc" rows="3" placeholder="Voice, quirks, boundaries, specialties…"></textarea>
        </div>
        <div class="field">
          <label for="personaGoal">Goal</label>
          <textarea id="personaGoal" rows="2" placeholder="Primary mission or KPI…"></textarea>
        </div>
        <div class="row">
          <button id="addPersona" class="action primary">Create Persona</button>
          <button id="clearPersona" class="action ghost">Reset</button>
        </div>

        <div class="divider"></div>

        <div class="collapser" id="agentsToggle" data-open="true" aria-controls="agentsList">
          <strong>Agents Made</strong>
          <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="collapsible agents" id="agentsList" data-open="true">
          <div class="small">No agents yet — create one above.</div>
        </div>

        <div class="divider"></div>

        <h3>Character Portrait</h3>
        <div class="small">Generate an image for your character (hook up model later).</div>
        <div class="row">
          <button class="action primary">Generate Portrait</button>
          <button class="action ghost">Upload</button>
        </div>

        <div class="divider"></div>

        <div class="toggle">
          <div>
            <b>Battle Mode</b><br>
            <span class="small">AIs take turns “driving”.</span>
          </div>
          <div class="switch" id="battleSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="divider"></div>

        <h3>View the Vibe</h3>
        <div class="small">Aesthetic tuner for the UI theme.</div>
        <div class="row">
          <input type="range" min="0" max="100" value="60" id="vibeSlider" />
          <button class="action ghost" id="vibeRandom">Shuffle</button>
        </div>
        
        <div class="divider"></div>

        <h3>AI Control</h3>
        <div class="toggle">
          <div>
            <b>Dynamic Theme</b><br>
            <span class="small">AI sets UI colors & chat background.</span>
          </div>
          <div class="switch" id="aiThemeSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>
        
      </div>
    </aside>

    <div class="panel footer">
      <div class="status">Layout ready • UI elements are interactive (no backend).</div>
      <div class="eq" aria-label="vibe visualizer"></div>
    </div>
  </div>

  <div class="pip" id="pip">
    <div class="bar" id="pipDrag">
      <div class="title">PiP Browser</div>
      <div class="row" style="gap:6px; align-items:center;">
        <button class="action ghost" id="pipMin">Min</button>
        <button class="action" id="pipClose">Close</button>
      </div>
    </div>
    <iframe id="pipFrame" src="about:blank" title="PiP Browser"></iframe>
    <div class="resize" id="pipResize" aria-hidden="true"></div>
  </div>

  <div class="persona-preview" id="personaPreview" aria-hidden="true">
    <button class="close" id="personaPreviewClose" aria-label="Close persona preview">×</button>
    <img id="personaPreviewImg" src="" alt="Persona portrait preview" />
    <div class="content">
      <div class="meta" id="personaPreviewMeta">New persona</div>
      <div class="title" id="personaPreviewTitle">Preview</div>
      <div class="desc" id="personaPreviewDesc">Generate a persona to see a quick-look card.</div>
    </div>
  </div>

<script>
  // Utility toast
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position = 'fixed';
    t.style.left = '50%';
    t.style.bottom = '26px';
    t.style.transform = 'translateX(-50%)';
    t.style.background = 'linear-gradient(90deg, #ff00a0, #00ffff)';
    t.style.color = 'white';
    t.style.textShadow = '0 1px 3px #000';
    t.style.padding = '10px 16px';
    t.style.borderRadius = '10px';
    t.style.zIndex = 9999;
    t.style.fontWeight = '800';
    t.style.border = '1px solid rgba(255,255,255,.3)';
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 1400);
  }

  // Collapser
  const agentsToggle = document.getElementById('agentsToggle');
  const agentsList = document.getElementById('agentsList');
  agentsToggle?.addEventListener('click', ()=>{
    const open = agentsToggle.getAttribute('data-open') === 'true';
    agentsToggle.setAttribute('data-open', (!open).toString());
    agentsList.setAttribute('data-open', (!open).toString());
  });

  // Create persona
  const addPersona = document.getElementById('addPersona');
  const clearPersona = document.getElementById('clearPersona');
  const personaPreview = document.getElementById('personaPreview');
  const personaPreviewImg = document.getElementById('personaPreviewImg');
  const personaPreviewMeta = document.getElementById('personaPreviewMeta');
  const personaPreviewTitle = document.getElementById('personaPreviewTitle');
  const personaPreviewDesc = document.getElementById('personaPreviewDesc');
  const personaPreviewClose = document.getElementById('personaPreviewClose');
  let personaPreviewTimer;

  const bodyGradients = {
    'thick': ['#ff4d7e', '#ffb400'],
    'skinny': ['#00ffff', '#4dffcf'],
    'big-bust': ['#ff00a0', '#ff6bd6'],
    'small-bust': ['#8c52ff', '#00c6ff'],
    'monster-booty': ['#ff8c42', '#ff2d55'],
    'athletic': ['#20bf55', '#00d4ff'],
    'curvy': ['#ff5f6d', '#ffc371'],
    'petite': ['#c400ff', '#00ffff']
  };

  function generatePersonaPreviewImage(name, body){
    const [c1, c2] = bodyGradients[body] || ['#ff00a0', '#00ffff'];
    const initial = (name || '?').trim().charAt(0).toUpperCase() || '★';
    const svg = `<?xml version="1.0" encoding="UTF-8"?>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 320">
        <defs>
          <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="${c1}" />
            <stop offset="100%" stop-color="${c2}" />
          </linearGradient>
        </defs>
        <rect width="480" height="320" fill="url(#grad)"/>
        <circle cx="80" cy="80" r="40" fill="rgba(0,0,0,0.18)" />
        <circle cx="400" cy="60" r="70" fill="rgba(255,255,255,0.08)" />
        <circle cx="420" cy="260" r="40" fill="rgba(0,0,0,0.2)" />
        <text x="50%" y="54%" text-anchor="middle" fill="rgba(0,0,0,0.16)" font-family="'Montserrat',sans-serif" font-size="220" font-weight="800" letter-spacing="8">${initial}</text>
      </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  function formatPersonaMeta(role, body){
    const parts = [];
    if(role) parts.push(role);
    if(body) parts.push(body.replace(/-/g, ' '));
    return parts.join(' • ') || 'Original creation';
  }

  function hidePersonaPreview(){
    if(!personaPreview) return;
    personaPreview.classList.remove('visible');
    personaPreview.setAttribute('aria-hidden', 'true');
    if(personaPreviewTimer){
      clearTimeout(personaPreviewTimer);
      personaPreviewTimer = undefined;
    }
  }

  function showPersonaPreview(name, role, body, desc){
    if(!personaPreview) return;
    personaPreviewImg.src = generatePersonaPreviewImage(name, body);
    personaPreviewTitle.textContent = name || 'Unnamed';
    personaPreviewMeta.textContent = formatPersonaMeta(role, body);
    const copy = desc ? desc.trim() : '';
    const short = copy.length > 160 ? copy.slice(0, 157) + '…' : (copy || 'Ready for the duel arena.');
    personaPreviewDesc.textContent = short;
    personaPreview.classList.add('visible');
    personaPreview.setAttribute('aria-hidden', 'false');
    if(personaPreviewTimer){
      clearTimeout(personaPreviewTimer);
    }
    personaPreviewTimer = window.setTimeout(() => hidePersonaPreview(), 6000);
  }

  personaPreviewClose?.addEventListener('click', hidePersonaPreview);
  addPersona?.addEventListener('click', ()=>{
    const name  = document.getElementById('personaName').value.trim() || 'Unnamed';
    const role  = document.getElementById('personaRole').value.trim();
    const body  = document.getElementById('personaBody').value;
    const desc  = document.getElementById('personaDesc').value.trim();
    const goal  = document.getElementById('personaGoal').value.trim();

    const wrap = document.createElement('div');
    wrap.className = 'agent';
    const left = document.createElement('div');
    left.innerHTML = '<b>'+name+'</b><div class="small">'+(role ? role+' • ' : '')+body.replace('-', ' ')+'</div>';
    const right = document.createElement('div');
    const use = document.createElement('button');
    use.className = 'action primary'; use.textContent = 'Use';
    right.appendChild(use);
    wrap.appendChild(left); wrap.appendChild(right);

    // Replace placeholder message if present
    const placeholder = agentsList.querySelector('.small');
    if(placeholder && agentsList.children.length === 1){ placeholder.remove(); }
    agentsList.appendChild(wrap);
    toast('Agent “'+name+'” added');
    showPersonaPreview(name, role, body, desc || goal);
  });
  clearPersona?.addEventListener('click', ()=>{
    ['personaName','personaRole','personaDesc','personaGoal'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('personaBody').selectedIndex = 0;
  });

  // Battle switch
  const battleSwitch = document.getElementById('battleSwitch');
  battleSwitch?.addEventListener('click', ()=>{
    const on = battleSwitch.getAttribute('data-on') === 'true';
    battleSwitch.setAttribute('data-on', (!on).toString());
    battleSwitch.setAttribute('aria-checked', (!on).toString());
    toast('Battle Mode: ' + (!on ? 'ON' : 'OFF'));
  });

  // Stars rating (−5..−1, +1..+5)
  const stars = Array.from(document.querySelectorAll('.star'));
  stars.forEach(btn => btn.addEventListener('click', () => {
    stars.forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    const score = btn.getAttribute('data-score');
    // Simulate write to memory
    toast('Saved rating ' + score + ' to Memory');
  }));

  // Dropzone (FunScript)
  const drop = document.getElementById('funsDrop');
  const browse = document.getElementById('browseFuns');
  const finput = document.getElementById('funsInput');
  const funsStatus = document.getElementById('funsStatus');
  const funsList = document.getElementById('funsList');

  function setFunsStatus(msg, state = 'info'){
    if(!funsStatus) return;
    funsStatus.textContent = msg;
    funsStatus.setAttribute('data-state', state);
  }

  function renderFunsCatalog(catalog){
    if(!funsList) return;
    funsList.innerHTML = '';
    if(!catalog || !catalog.length){
      setFunsStatus('No FunScripts uploaded yet.', 'idle');
      return;
    }
    setFunsStatus(`Loaded ${catalog.length} FunScript${catalog.length === 1 ? '' : 's'}.`, 'success');
    catalog.forEach(entry => {
      const card = document.createElement('div');
      card.className = 'funs-card';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = entry.name || 'FunScript';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const duration = entry.metrics?.duration_ms ? Math.round(entry.metrics.duration_ms / 1000) : 0;
      meta.textContent = duration ? `${duration}s • ${entry.metrics?.intensity ?? 0}% intensity` : 'Awaiting metrics';
      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.textContent = entry.analysis?.summary || 'No summary available yet.';
      const tags = document.createElement('div');
      tags.className = 'funs-tags';
      (entry.analysis?.style_tags || []).slice(0,5).forEach(tag => {
        const chip = document.createElement('span');
        chip.className = 'funs-tag';
        chip.textContent = tag;
        tags.appendChild(chip);
      });
      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(summary);
      if(entry.analysis?.signature_moves?.length){
        const move = entry.analysis.signature_moves[0];
        const moveLine = document.createElement('div');
        moveLine.className = 'meta';
        moveLine.textContent = `Signature move: ${move.label}`;
        card.appendChild(moveLine);
      }
      if(tags.children.length) card.appendChild(tags);
      funsList.appendChild(card);
    });
  }

  async function refreshFunsCatalog(){
    setFunsStatus('Loading FunScript library…', 'info');
    try{
      const res = await fetch('/api/funscripts');
      if(!res.ok) throw new Error('Failed to fetch');
      const data = await res.json();
      renderFunsCatalog(data.catalog || []);
    } catch(err){
      console.warn('FunScript catalog load failed', err);
      setFunsStatus('Unable to load FunScript catalog.', 'warn');
    }
  }

  async function uploadFunscripts(files){
    if(!files.length) return;
    const form = new FormData();
    files.forEach(file => form.append('files', file));
    drop?.classList.add('loading');
    setFunsStatus(`Uploading ${files.length} file${files.length === 1 ? '' : 's'}…`, 'info');
    try{
      const res = await fetch('/api/funscripts', { method:'POST', body: form });
      const data = await res.json();
      if(res.status === 200 || res.status === 207){
        const processed = data.processed?.length ?? 0;
        const state = res.status === 207 ? 'warn' : 'success';
        setFunsStatus(`Processed ${processed} file${processed === 1 ? '' : 's'}.`, state);
        if(data.errors?.length){
          toast(`${data.errors.length} upload${data.errors.length === 1 ? '' : 's'} skipped.`);
        }
        renderFunsCatalog(data.catalog || []);
      } else {
        const message = data.errors?.[0]?.message || data.message || 'Upload failed.';
        setFunsStatus(message, 'error');
      }
    } catch(err){
      console.error('FunScript upload failed', err);
      setFunsStatus('Upload failed. See console for details.', 'error');
    } finally {
      drop?.classList.remove('loading');
    }
  }

  function filterFuns(files){
    return [...files].filter(f => /\.(funscript|json)$/i.test(f.name));
  }

  browse?.addEventListener('click', ()=> finput?.click());
  finput?.addEventListener('change', (e)=>{
    const files = filterFuns(e.target.files || []);
    if(!files.length) return setFunsStatus('No FunScript files selected.', 'warn');
    uploadFunscripts(files);
    e.target.value = '';
  });

  ['dragover','dragleave','drop'].forEach(evt=> drop?.addEventListener(evt, e => {
    e.preventDefault(); e.stopPropagation();
    if(evt === 'dragover'){ drop.classList.add('loading'); }
    if(evt === 'dragleave'){ drop.classList.remove('loading'); }
    if(evt === 'drop'){
      drop.classList.remove('loading');
      const files = filterFuns(e.dataTransfer.files || []);
      if(!files.length) return setFunsStatus('No FunScript files detected.', 'warn');
      uploadFunscripts(files);
    }
  }));

  refreshFunsCatalog();

  // PiP
  const togglePip = document.getElementById('togglePip');
  const pip = document.getElementById('pip');
  const pipClose = document.getElementById('pipClose');
  const pipMin = document.getElementById('pipMin');
  const pipDrag = document.getElementById('pipDrag');
  const pipResize = document.getElementById('pipResize');
  const pipFrame = document.getElementById('pipFrame');
  const openUrl = document.getElementById('openUrl');
  togglePip?.addEventListener('click', ()=>{
    pip.classList.toggle('visible');
  });
  pipClose?.addEventListener('click', ()=> pip.classList.remove('visible'));
  pipMin?.addEventListener('click', ()=>{
    if(pip.style.height !== '60px'){ pip.dataset.prev = JSON.stringify({w:pip.style.width,h:pip.style.height}); pip.style.height = '60px'; }
    else {
      try { const prev = JSON.parse(pip.dataset.prev || '{}'); pip.style.height = prev.h || '240px'; } catch {}
    }
  });
  openUrl?.addEventListener('click', ()=>{
    const url = document.getElementById('pipUrl').value.trim();
    if(!url) return toast('Enter a URL first');
    try {
      const u = new URL(url.match(/^https?:\/\//) ? url : 'https://' + url);
      pipFrame.src = u.href;
      if(!pip.classList.contains('visible')) pip.classList.add('visible');
    } catch { toast('Invalid URL'); }
  });

  // Drag logic
  (function enableDrag(el, handle){
    let ox, oy, left, top; 
    function onDown(e){
      const r = el.getBoundingClientRect();
      left = r.left; top = r.top;
      ox = (e.touches? e.touches[0].clientX : e.clientX) - left;
      oy = (e.touches? e.touches[0].clientY : e.clientY) - top;
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
    }
    function onMove(e){
      const x = (e.touches? e.touches[0].clientX : e.clientX) - ox;
      const y = (e.touches? e.touches[0].clientY : e.clientY) - oy;
      el.style.left = Math.max(8, Math.min(window.innerWidth - el.offsetWidth - 8, x)) + 'px';
      el.style.top  = Math.max(8, Math.min(window.innerHeight - el.offsetHeight - 8, y)) + 'px';
      el.style.right = 'auto'; el.style.bottom = 'auto'; // anchor from left/top once dragged
    }
    function onUp(){
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('mouseup', onUp);
      window.removeEventListener('touchend', onUp);
    }
    handle.addEventListener('mousedown', onDown);
    handle.addEventListener('touchstart', onDown);
  })(pip, pipDrag);

  // Resize logic
  (function enableResize(el, handle){
    let startX, startY, startW, startH;
    function onDown(e){
      startX = (e.touches? e.touches[0].clientX : e.clientX);
      startY = (e.touches? e.touches[0].clientY : e.clientY);
      const r = el.getBoundingClientRect();
      startW = r.width; startH = r.height;
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
    }
    function onMove(e){
      const x = (e.touches? e.touches[0].clientX : e.clientX);
      const y = (e.touches? e.touches[0].clientY : e.clientY);
      let w = Math.max(260, startW + (x - startX));
      let h = Math.max(160, startH + (y - startY));
      el.style.width = w + 'px';
      el.style.height = h + 'px';
    }
    function onUp(){
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('mouseup', onUp);
      window.removeEventListener('touchend', onUp);
    }
    handle.addEventListener('mousedown', onDown);
    handle.addEventListener('touchstart', onDown);
  })(pip, pipResize);

  // Mic button (visual only)
  const micBtn = document.getElementById('micBtn');
  let micOn = false;
  micBtn?.addEventListener('click', ()=>{
    micOn = !micOn;
    micBtn.style.outline = micOn ? '4px solid rgba(255, 0, 150, 0.4)' : 'none';
    micBtn.style.borderColor = micOn ? '#ff00a0' : 'var(--edge)';
    toast('Mic ' + (micOn ? 'listening (UI only)' : 'off'));
  });

  // Save layout (UI only)
  const saveLayout = document.getElementById('saveLayout');
  saveLayout?.addEventListener('click', ()=> toast('Layout saved (stub)'));

  // --- NEW --- AI Theme Control Logic
  const aiThemeSwitch = document.getElementById('aiThemeSwitch');
  const mainPanel = document.querySelector('.main.panel');
  aiThemeSwitch?.addEventListener('click', ()=>{
    const on = aiThemeSwitch.getAttribute('data-on') === 'true';
    aiThemeSwitch.setAttribute('data-on', (!on).toString());
    aiThemeSwitch.setAttribute('aria-checked', (!on).toString());
    mainPanel.classList.toggle('ai-themed', !on);
    toast('AI Dynamic Theme: ' + (!on ? 'ON' : 'OFF'));
  });
</script>
</body>
</html>
